//----------------------
// <auto-generated>
//   Generated using the Test262Harness v1.0.3.0
//   Suite Git SHA: a073f479f80b336256b7fc4e04700c827293e2fe
//   Suite Directory: 
//   Template SHA: 60661AD174ADA80DDD36651F8424EB7CE2B4FBE1C30B5F300887C530004DF652
//   Command line:  /home/runner/.nuget/packages/test262harness.console/1.0.3/tools/net8.0/any/Test262Harness.Console.dll generate
//   Settings file: /home/runner/work/Asynkron.JsEngine/Asynkron.JsEngine/tests/Asynkron.JsEngine.Tests.Test262/Test262Harness.settings.json
// </auto-generated>
//----------------------

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

using NUnit.Framework.Internal;

using Test262Harness;

namespace Asynkron.JsEngine.Tests.Test262;

/// <summary>
/// Global state for test run. Generated test suite requires that Test262Stream is initialized before tests start to run.
/// </summary>
public static partial class State
{
    /// <summary>
    /// The GitHub SHA used to generate the test suite. Runner should initialize Test262Stream using this value.
    /// </summary>
    public const string GitHubSha = "a073f479f80b336256b7fc4e04700c827293e2fe";

    public const string SuiteDirectory = @"";

    public static Test262Stream Test262Stream { get; set; }

    public static Test262File[] HarnessFiles { get; set; }

    public static Func<Task<Test262Stream>> Test262StreamLoader { get; set; } = () => Test262StreamExtensions.FromGitHub(State.GitHubSha);

}

/// <summary>
/// Handles initializing testing state.
/// </summary>
[SetUpFixture]
public partial class TestHarness
{
    [OneTimeSetUp]
    public async Task RunBeforeAnyTests()
    {
        var stream = await State.Test262StreamLoader();
        State.Test262Stream = stream;
        State.HarnessFiles = State.Test262Stream.GetHarnessFiles().ToArray();

        await InitializeCustomState();
    }

    private static partial Task InitializeCustomState();
}


[Parallelizable(ParallelScope.All)]
public abstract partial class Test262Test
{
    protected void RunTestCode(string test, bool strict)
    {
        var testCase = State.Test262Stream.GetTestFile(test);
        if (strict)
        {
            testCase = testCase.AsStrict();
        }

        string lastError = null;
        try
        {
            var executor = BuildTestExecutor(testCase);

            ExecuteTest(executor, testCase);

            if (ShouldThrow(testCase, strict))
            {
                ThrowError(testCase, "Expected error to be thrown, but no error was thrown");
            }
        }
        catch (Exception e)
        {
            lastError = e.ToString();
        }

        if (!testCase.Negative && !string.IsNullOrWhiteSpace(lastError))
        {
            ThrowError(testCase, lastError);
        }
    }

    private partial bool ShouldThrow(Test262File testCase, bool strict); 

    private void ThrowError(Test262File testCase, string lastError)
    {
        // create friendly formatted code as we have different line numbers compared to original file having comments etc
        var code = string.Join(Environment.NewLine, testCase.Program.Split('\n').Select((x, i) => $"{i + 1:00}: {x}"));
        var message = $"{Environment.NewLine}{testCase.FileName}{Environment.NewLine}{Environment.NewLine}{lastError}{Environment.NewLine}{code}";
        Assert.Fail(message);    
    }
}
